# Story 01.03: Import/Export and Validation System

## Status
Ready for Review

## Story
**As a** developer or PM working with existing Google Slides configurations,
**I want** robust import/export functionality with comprehensive validation,
**so that** I can safely load, modify, and export batchUpdate configurations with confidence they'll work with the Google Slides API.

## Acceptance Criteria

1. Import dialog accepts JSON files and validates them against Google Slides batchUpdate API schema
2. File validation provides specific error messages and suggestions for common issues
3. Successfully imported JSON loads into both editor and preview with all elements visible
4. Export functionality generates clean, valid batchUpdate JSON ready for API use
5. Markdown export includes structured format with user-editable title/description and JSON code block
6. Real-time validation continuously checks batchUpdate array integrity with visual indicators
7. Validation errors prevent export and provide actionable feedback to users
8. File operations handle edge cases (large files, corrupted data, empty files) gracefully
9. Browser File System API integration works seamlessly for save/load operations
10. All file operations maintain data integrity without corruption or loss

## Tasks / Subtasks

- [x] **Implement JSON Validation System** (AC: 1, 6, 7)
  - [x] Create Zod schemas matching Google Slides batchUpdate API specification
  - [x] Build ValidationService with comprehensive error reporting
  - [x] Implement real-time validation pipeline with performance optimization
  - [x] Add validation error UI components with specific error messaging

- [x] **Build File Import Functionality** (AC: 1, 2, 3, 8)
  - [x] Create ImportDialog component with file picker and validation
  - [x] Implement JSON parsing with error handling for malformed files
  - [x] Add large file handling with progress indicators and streaming
  - [x] Build import validation with detailed error reporting and fix suggestions

- [x] **Create Export System** (AC: 4, 5, 9)
  - [x] Implement JSON export with clean formatting and validation
  - [x] Create Markdown export with structured template format
  - [x] Build ExportDialog with filename selection and format options
  - [x] Add browser File System API integration for save operations

- [x] **Implement File Operations Manager** (AC: 8, 9, 10)
  - [x] Create FileOperationsManager component coordinating import/export
  - [x] Add error handling for file system permissions and browser limitations
  - [x] Implement file size validation and user warnings
  - [x] Build backup and recovery system for unsaved changes

- [x] **Build Validation User Interface** (AC: 6, 7)
  - [x] Create ValidationBadge components with status indicators
  - [x] Implement real-time validation feedback in editor panels
  - [x] Add ValidationErrorList component with actionable error descriptions
  - [x] Build export blocking system when validation fails

- [x] **Integrate with State Management** (AC: 3, 6, 10)
  - [x] Connect file operations to Zustand batchUpdate store
  - [x] Implement state validation hooks for real-time checking
  - [x] Add import state management with loading and error states
  - [x] Create export state management with progress tracking

## Dev Notes

### Architecture References
From docs/architecture.md:
- **Validation Strategy**: Zod schemas with strict Google Slides API compliance
- **File Operations**: Browser File System API for client-side import/export
- **State Management**: Zustand store with `batchUpdateRequests: BatchUpdateRequest[]`
- **Error Handling**: Structured error responses with actionable feedback

### Google Slides API Validation Requirements
**Critical batchUpdate Validation**:
```typescript
interface BatchUpdateRequest {
  createShape?: CreateShapeRequest;
  updateShapeProperties?: UpdateShapePropertiesRequest;
  createTextBox?: CreateTextBoxRequest;
  updateTextStyle?: UpdateTextStyleRequest;
  deleteObject?: DeleteObjectRequest;
}
```

**Required Field Validation**:
- `objectId`: String, unique within presentation
- `pageObjectId`: Valid slide identifier
- `elementProperties.size`: Width/height with magnitude and unit (PT/EMU)
- `elementProperties.transform`: Position coordinates with proper units

### File Format Standards
**JSON Export Format**: Clean, validated batchUpdate array
**Markdown Export Format**:
```markdown
# Alkemy GSlide Export (timestamp)
## Slide Title: [User Input]
## Slide Description: [Optional User Input]
## Google Slides batchUpdate JSON
```json
[...batchUpdate array...]
```

### Browser Integration
- **File System Access API**: For save/load operations
- **Drag-and-Drop API**: For file import UX enhancement
- **Local Storage**: For user preferences and autosave
- **Session Storage**: For working state persistence

### Error Handling Strategy
**Validation Error Types**:
- Syntax errors (malformed JSON)
- Schema errors (missing required fields)
- API compliance errors (invalid property values)
- Coordinate errors (elements outside slide bounds)

### Testing
**Test Framework**: Bun Test + React Testing Library + Playwright
**Test Location**: `tests/services/`, `tests/integration/`, `tests/e2e/`

**Specific Testing Requirements**:
- Unit tests for validation schemas and file operations
- Component tests for import/export dialogs and validation UI
- Integration tests for complete import-edit-export workflows
- E2E tests with sample batchUpdate files and error scenarios
- Performance tests for large file handling and validation speed

### Performance Considerations
- **Large File Handling**: Stream processing for files > 1MB
- **Validation Performance**: Debounced real-time validation to prevent UI blocking
- **Memory Management**: Efficient cleanup of file operations and validation results
- **Browser Limits**: Handle quota exceeded errors gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-02 | v1.0 | Initial story creation | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Implemented comprehensive Zod validation schemas for Google Slides batchUpdate API
- Created ValidationService with error reporting and custom validations
- Built real-time validation hooks with debouncing for performance
- Developed import/export dialogs with file handling and validation
- Integrated validation with Zustand store for state management

### Completion Notes List
- All validation schemas properly handle Google Slides API requirements
- Real-time validation provides immediate feedback with debouncing
- Import dialog supports drag-and-drop and file size validation
- Export supports both JSON and Markdown formats with metadata
- File operations include auto-save and recovery features
- Validation UI components provide clear error messaging with suggestions
- Tests written for validation service and schemas

### File List
**Created:**
- lib/validation/schemas/batch-update.schema.ts
- lib/services/ValidationService.ts
- lib/hooks/useRealtimeValidation.ts
- lib/hooks/useStoreValidation.ts
- lib/utils/debounce.ts
- app/components/validation/ValidationBadge.tsx
- app/components/validation/ValidationErrorList.tsx
- app/components/validation/ValidationPanel.tsx
- app/components/import-export/ImportDialog.tsx
- app/components/import-export/ExportDialog.tsx
- app/components/import-export/FileOperationsManager.tsx
- tests/validation.test.ts

**Modified:**
- package.json (added zod dependency)

## QA Results

*Results from QA Agent review will be populated here after implementation*